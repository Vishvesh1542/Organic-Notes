name: Merge and Clean HTML Comments

on:
  pull_request:
    branches:
      - main  # Trigger on pull requests to the main branch

jobs:
  merge_and_clean:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.sha }} # Checkout the PR branch

      - name: Merge main branch
        run: git merge main

      - name: Remove HTML comments (if Vishvesh branch)
        if: github.event.pull_request.head.ref == 'vishvesh'  # Check if PR is from vishvesh
        run: |
          find . -type f -name "*.html" -print0 | xargs -0 -I {} sed -i 's///g' {}  # Remove comments from HTML files
          # OR, for more robust comment removal (handles multi-line comments):
          # find . -type f -name "*.html" -print0 | xargs -0 -I {} perl -0777 -pe 's///sg' {}

      - name: Commit changes (if comments were removed)
        if: github.event.pull_request.head.ref == 'vishvesh' # Only commit if on vishvesh branch
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Removed HTML comments" || true # Allow commit to succeed even if no changes

      - name: Push changes (if comments were removed)
        if: github.event.pull_request.head.ref == 'vishvesh'
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.event.pull_request.head.ref }} # Push back to the PR branch
